{% extends 'base.html' %}
{% block content %}
<h1 class="text-center mb-4">Poll Questions</h1>

<!-- Search and Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="d-flex flex-wrap gap-2">
            <input type="text" name="search" class="form-control" placeholder="Search polls..." value="{{ search_query }}" style="flex: 1; min-width: 200px;">
            
            <select name="category" class="form-control" style="flex: 1; min-width: 150px;">
                <option value="">All Categories</option>
                {% for cat in categories %}
                    <option value="{{ cat.slug }}" {% if selected_category == cat.slug %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
            </select>
            
            <select name="status" class="form-control" style="flex: 1; min-width: 120px;">
                <option value="active" {% if status == 'active' %}selected{% endif %}>Active</option>
                <option value="upcoming" {% if status == 'upcoming' %}selected{% endif %}>Upcoming</option>
                <option value="expired" {% if status == 'expired' %}selected{% endif %}>Expired</option>
                <option value="all" {% if status == 'all' %}selected{% endif %}>All</option>
            </select>
            
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="{% url 'polls:index' %}" class="btn btn-secondary">Clear</a>
        </form>
    </div>
</div>

{% if not user.is_authenticated %}
<div class="alert alert-info">
    <strong>Note:</strong> <a href="{% url 'accounts:login' %}" class="alert-link">Login</a> to vote on polls. 
    Don't have an account? <a href="{% url 'accounts:register' %}" class="alert-link">Register here</a>.
</div>
{% endif %}

{% if polls %}
    {% for question in polls %}
    <div class="card mb-3">
        <div class="row no-gutters">
            {% if question.image %}
            <div class="col-md-3">
                <img src="{{ question.image.url }}" class="card-img" alt="Poll image" style="height: 200px; object-fit: cover;">
            </div>
            {% endif %}
            <div class="{% if question.image %}col-md-9{% else %}col-md-12{% endif %}">
                <div class="card-body">
                    <h5 class="card-title">{{ question.question_text }}</h5>
                    
                    {% if question.description %}
                        <p class="text-muted small">{{ question.description|truncatewords:20 }}</p>
                    {% endif %}
                    
                    <div class="mb-2">
                        {% if question.category %}
                            <a href="{% url 'polls:category' question.category.slug %}" class="badge bg-info text-dark">{{ question.category.name }}</a>
                        {% endif %}
                        
                        {% if question.allow_multiple_choices %}
                            <span class="badge bg-warning text-dark">Multiple Choice</span>
                        {% endif %}
                        
                        {% if question.visibility == 'password' %}
                            <span class="badge bg-secondary">üîí Password Protected</span>
                        {% elif question.visibility == 'private' %}
                            <span class="badge bg-dark">üîí Private</span>
                            {% if user.is_authenticated and user in question.invited_users.all %}
                                <span class="badge bg-info text-dark">üë• Invited</span>
                            {% endif %}
                        {% endif %}
                        
                        {% if question.is_upcoming %}
                            <span class="badge bg-info text-dark">üìÖ Upcoming</span>
                        {% elif question.is_expired %}
                            <span class="badge bg-danger">‚è∞ Expired</span>
                        {% elif question.is_active %}
                            <span class="badge bg-success">‚úÖ Active</span>
                        {% endif %}
                        
                        {% if user.is_authenticated and question.id in user_votes %}
                            <span class="badge bg-primary">‚úì You Voted</span>
                        {% endif %}
                    </div>
                    
                    <p class="text-muted small mb-2">
                        <strong>Total Votes:</strong> {{ question.total_votes }} | 
                        <strong>Posted:</strong> {{ question.pub_date|date:"M d, Y" }}
                        {% if question.end_date %}
                            | <strong>Ends:</strong> {{ question.end_date|date:"M d, Y H:i" }}
                        {% endif %}
                    </p>
                    
                    <div class="mt-2">
                        {% if question.is_active %}
                            {% if user.is_authenticated %}
                                <a href="{% url 'polls:detail' question.id %}" class="btn btn-primary btn-sm">
                                    {% if question.id in user_votes %}Change Vote{% else %}Vote Now!{% endif %}
                                </a>
                            {% else %}
                                <a href="{% url 'accounts:login' %}?next={% url 'polls:detail' question.id %}" class="btn btn-primary btn-sm">Login to Vote</a>
                            {% endif %}
                        {% else %}
                            <button class="btn btn-secondary btn-sm" disabled>Poll Closed</button>
                        {% endif %}
                        <a href="{% url 'polls:results' question.id %}" class="btn btn-outline-secondary btn-sm">View Results</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-warning">
        <p class="mb-0">No polls found matching your criteria.</p>
    </div>
{% endif %}
{% endblock %}